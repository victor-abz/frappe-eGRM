{% extends "templates/web.html" %}

{% block title %}Track Your Complaint{% endblock %}

{% block style %}
<style>
:root {
    --grm-bg: #FFFFFF;
    --grm-bg-alt: #F8F8F8;
    --grm-border: #EDEDED;
    --grm-text: #171717;
    --grm-text-secondary: #525252;
    --grm-text-muted: #7C7C7C;
    --grm-accent: #2490EF;
    --grm-accent-hover: #1A6FC2;
    --grm-radius: 8px;
    --grm-radius-sm: 6px;
}

/* Nav strip */
.grm-nav { display:flex; align-items:center; gap:4px; padding:10px 20px; border-bottom:1px solid var(--grm-border); margin:-15px -15px 32px -15px; background:var(--grm-bg); flex-wrap:wrap; }
.grm-nav-brand { font-size:14px; font-weight:600; color:var(--grm-text); text-decoration:none; margin-right:auto; white-space:nowrap; }
.grm-nav-brand:hover { color:var(--grm-text); text-decoration:none; }
.grm-nav-link { display:inline-flex; align-items:center; gap:6px; padding:6px 12px; font-size:13px; font-weight:500; color:var(--grm-text-secondary); text-decoration:none; border-radius:var(--grm-radius-sm); transition:background .15s,color .15s; white-space:nowrap; }
.grm-nav-link:hover { background:var(--grm-bg-alt); color:var(--grm-text); text-decoration:none; }
.grm-nav-link.active { background:var(--grm-bg-alt); color:var(--grm-accent); }
.grm-nav-link svg { width:16px; height:16px; flex-shrink:0; }

/* Track form */
.grm-track-wrapper {
    max-width: 480px;
    margin: 0 auto;
    padding: 40px 0;
}
.grm-track-header {
    text-align: center;
    margin-bottom: 28px;
}
.grm-track-header h1 {
    font-size: 22px;
    font-weight: 600;
    color: var(--grm-text);
    margin: 0 0 6px 0;
}
.grm-track-header p {
    font-size: 14px;
    color: var(--grm-text-muted);
    margin: 0;
}
.grm-input-group {
    position: relative;
    margin-bottom: 12px;
}
.grm-input-group svg {
    position: absolute;
    left: 12px;
    top: 50%;
    transform: translateY(-50%);
    width: 18px;
    height: 18px;
    color: var(--grm-text-muted);
    pointer-events: none;
}
.grm-input {
    width: 100%;
    padding: 10px 14px 10px 38px;
    font-size: 14px;
    border: 1px solid var(--grm-border);
    border-radius: var(--grm-radius-sm);
    outline: none;
    color: var(--grm-text);
    transition: border-color .15s;
    box-sizing: border-box;
}
.grm-input:focus { border-color: var(--grm-accent); }
.grm-input::placeholder { color: var(--grm-text-muted); }
.grm-btn-primary {
    width: 100%;
    padding: 10px 16px;
    font-size: 14px;
    font-weight: 500;
    background: var(--grm-accent);
    color: white;
    border: none;
    border-radius: var(--grm-radius-sm);
    cursor: pointer;
    transition: background .15s;
    min-height: 44px;
}
.grm-btn-primary:hover { background: var(--grm-accent-hover); }

/* Error message */
.grm-error {
    font-size: 13px;
    color: #DC3545;
    padding: 8px 0;
    display: none;
}
.grm-error.show { display: block; }

/* Result card */
.grm-result {
    border: 1px solid var(--grm-border);
    border-radius: var(--grm-radius);
    margin-top: 24px;
    display: none;
}
.grm-result.show { display: block; }
.grm-result-header {
    font-size: 14px;
    font-weight: 600;
    padding: 14px 18px;
    border-bottom: 1px solid var(--grm-border);
    color: var(--grm-text);
}
.grm-result-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 18px;
    font-size: 14px;
    border-bottom: 1px solid var(--grm-border);
}
.grm-result-row:last-child { border-bottom: none; }
.grm-result-label {
    color: var(--grm-text-muted);
    font-size: 13px;
}
.grm-result-value {
    color: var(--grm-text);
    font-weight: 500;
}

/* Status badges */
.grm-status-badge {
    display: inline-block;
    font-size: 12px;
    font-weight: 600;
    padding: 3px 10px;
    border-radius: 10px;
}
.grm-status-open { background: #E8F4FD; color: #2490EF; }
.grm-status-pending { background: #FFF3E0; color: #E67E22; }
.grm-status-resolved { background: #E8F5E9; color: #27AE60; }
.grm-status-appeal { background: #FFF3E0; color: #E67E22; }
</style>
{% endblock %}

{% block page_content %}
<div class="container">
    <!-- Nav strip -->
    <nav class="grm-nav">
        <a href="/grm-public" class="grm-nav-brand">GRM Portal</a>
        <a href="/grm-public/dashboard" class="grm-nav-link">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>
            Dashboard
        </a>
        <a href="/grm-public/track-complaint" class="grm-nav-link active">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
            Track
        </a>
        <a href="/grm-public/submit-grievance" class="grm-nav-link">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 19V5M5 12l7-7 7 7"/></svg>
            Submit
        </a>
        <a href="/grm-public/reports" class="grm-nav-link">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
            Reports
        </a>
    </nav>

    <div class="grm-track-wrapper">
        <div class="grm-track-header">
            <h1>Track Your Complaint</h1>
            <p>Enter your tracking code to check the status</p>
        </div>

        <div class="grm-input-group">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
            <input type="text" id="tracking_code" class="grm-input" placeholder="Enter tracking code" autocomplete="off">
        </div>

        <button onclick="trackComplaint()" class="grm-btn-primary">Track Complaint</button>

        <div id="error-msg" class="grm-error"></div>

        <div id="result-card" class="grm-result">
            <div class="grm-result-header">Complaint Status</div>
            <div class="grm-result-row">
                <span class="grm-result-label">Tracking Code</span>
                <span class="grm-result-value" id="result-code"></span>
            </div>
            <div class="grm-result-row">
                <span class="grm-result-label">Status</span>
                <span id="result-status"></span>
            </div>
            <div class="grm-result-row">
                <span class="grm-result-label">Category</span>
                <span class="grm-result-value" id="result-category"></span>
            </div>
            <div class="grm-result-row">
                <span class="grm-result-label">Submitted</span>
                <span class="grm-result-value" id="result-submitted"></span>
            </div>
            <div class="grm-result-row" id="ack-row" style="display:none;">
                <span class="grm-result-label">Acknowledged</span>
                <span class="grm-result-value" id="result-ack-date"></span>
            </div>
            <div class="grm-result-row" id="resolved-row" style="display:none;">
                <span class="grm-result-label">Resolved</span>
                <span class="grm-result-value" id="result-resolved-date"></span>
            </div>
            <div class="grm-result-row" id="appeal-row" style="display:none;">
                <span class="grm-result-label">Appeal</span>
                <span class="grm-status-badge grm-status-appeal">Appeal Submitted</span>
            </div>
        </div>
    </div>
</div>

<script>
function trackComplaint() {
    var trackingCode = document.getElementById('tracking_code').value.trim();
    var resultCard = document.getElementById('result-card');
    var errorMsg = document.getElementById('error-msg');

    resultCard.classList.remove('show');
    errorMsg.classList.remove('show');

    if (!trackingCode) {
        errorMsg.textContent = 'Please enter a tracking code.';
        errorMsg.classList.add('show');
        return;
    }

    frappe.call({
        method: 'egrm.api.public_tracking.track_complaint',
        args: { tracking_code: trackingCode },
        callback: function(r) {
            if (r.message && r.message.status === 'success') {
                var data = r.message.data;
                document.getElementById('result-code').textContent = data.tracking_code;
                document.getElementById('result-category').textContent = data.category || 'N/A';
                document.getElementById('result-submitted').textContent = data.submission_date || 'N/A';

                // Status badge
                var statusEl = document.getElementById('result-status');
                var st = (data.status || 'Unknown').toLowerCase();
                var cls = 'grm-status-open';
                if (st.indexOf('resolv') !== -1 || st.indexOf('clos') !== -1) cls = 'grm-status-resolved';
                else if (st.indexOf('pend') !== -1 || st.indexOf('progress') !== -1) cls = 'grm-status-pending';
                statusEl.innerHTML = '<span class="grm-status-badge ' + cls + '">' + (data.status || 'Unknown') + '</span>';

                if (data.acknowledged_date) {
                    document.getElementById('result-ack-date').textContent = data.acknowledged_date;
                    document.getElementById('ack-row').style.display = 'flex';
                } else {
                    document.getElementById('ack-row').style.display = 'none';
                }

                if (data.resolution_date) {
                    document.getElementById('result-resolved-date').textContent = data.resolution_date;
                    document.getElementById('resolved-row').style.display = 'flex';
                } else {
                    document.getElementById('resolved-row').style.display = 'none';
                }

                if (data.appeal_submitted) {
                    document.getElementById('appeal-row').style.display = 'flex';
                } else {
                    document.getElementById('appeal-row').style.display = 'none';
                }

                resultCard.classList.add('show');
            } else {
                errorMsg.textContent = (r.message && r.message.message) || 'Complaint not found.';
                errorMsg.classList.add('show');
            }
        },
        error: function() {
            errorMsg.textContent = 'Error tracking complaint. Please try again.';
            errorMsg.classList.add('show');
        }
    });
}

document.getElementById('tracking_code').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') { trackComplaint(); }
});
</script>
{% endblock %}
