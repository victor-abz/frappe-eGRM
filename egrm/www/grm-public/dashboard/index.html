{% extends "templates/web.html" %}

{% block title %}GRM Public Dashboard{% endblock %}

{% block style %}
<style>
:root {
    --grm-bg: #FFFFFF;
    --grm-bg-alt: #F8F8F8;
    --grm-border: #EDEDED;
    --grm-text: #171717;
    --grm-text-secondary: #525252;
    --grm-text-muted: #7C7C7C;
    --grm-accent: #2490EF;
    --grm-radius: 8px;
    --grm-radius-sm: 6px;
}

/* Nav strip */
.grm-nav { display:flex; align-items:center; gap:4px; padding:10px 20px; border-bottom:1px solid var(--grm-border); margin:-15px -15px 32px -15px; background:var(--grm-bg); flex-wrap:wrap; }
.grm-nav-brand { font-size:14px; font-weight:600; color:var(--grm-text); text-decoration:none; margin-right:auto; white-space:nowrap; }
.grm-nav-brand:hover { color:var(--grm-text); text-decoration:none; }
.grm-nav-link { display:inline-flex; align-items:center; gap:6px; padding:6px 12px; font-size:13px; font-weight:500; color:var(--grm-text-secondary); text-decoration:none; border-radius:var(--grm-radius-sm); transition:background .15s,color .15s; white-space:nowrap; }
.grm-nav-link:hover { background:var(--grm-bg-alt); color:var(--grm-text); text-decoration:none; }
.grm-nav-link.active { background:var(--grm-bg-alt); color:var(--grm-accent); }
.grm-nav-link svg { width:16px; height:16px; flex-shrink:0; }

/* Page header */
.grm-page-header { margin-bottom:24px; }
.grm-page-header h1 { font-size:22px; font-weight:600; color:var(--grm-text); margin:0 0 4px 0; }
.grm-page-header p { font-size:14px; color:var(--grm-text-muted); margin:0; }

/* Filter bar */
.grm-filter-bar {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px 16px;
    border: 1px solid var(--grm-border);
    border-radius: var(--grm-radius);
    margin-bottom: 24px;
    flex-wrap: wrap;
}
.grm-filter-label {
    font-size: 12px;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--grm-text-muted);
    white-space: nowrap;
}
.grm-filter-select {
    padding: 6px 10px;
    font-size: 13px;
    border: 1px solid var(--grm-border);
    border-radius: var(--grm-radius-sm);
    background: var(--grm-bg);
    color: var(--grm-text);
    outline: none;
    min-width: 140px;
}
.grm-filter-select:focus { border-color: var(--grm-accent); }
.grm-filter-divider {
    width: 1px;
    height: 24px;
    background: var(--grm-border);
}

/* Metric cards */
.grm-metrics {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 14px;
    margin-bottom: 32px;
}
@media (max-width: 768px) {
    .grm-metrics { grid-template-columns: repeat(2, 1fr); }
}
.grm-metric {
    padding: 16px;
    border: 1px solid var(--grm-border);
    border-radius: var(--grm-radius);
    text-align: center;
    transition: box-shadow .15s;
}
.grm-metric:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
.grm-metric-value {
    font-size: 24px;
    font-weight: 700;
    color: var(--grm-text);
    margin: 0;
    line-height: 1.2;
}
.grm-metric-label {
    font-size: 11px;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--grm-text-muted);
    margin: 6px 0 0 0;
}

/* Section title */
.grm-section-title {
    font-size: 12px;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--grm-text-muted);
    margin: 0 0 12px 0;
}

/* Tables */
.grm-table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 32px;
}
.grm-table th {
    font-size: 12px;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.3px;
    color: var(--grm-text-muted);
    padding: 8px 12px;
    text-align: left;
    border-bottom: 1px solid var(--grm-border);
}
.grm-table th:last-child { text-align: right; }
.grm-table td {
    font-size: 14px;
    color: var(--grm-text);
    padding: 10px 12px;
    border-bottom: 1px solid var(--grm-border);
}
.grm-table td:last-child { text-align: right; }
.grm-table tbody tr:nth-child(even) { background: var(--grm-bg-alt); }
.grm-table tbody tr:hover { background: #F2F2F2; }
.grm-badge {
    display: inline-block;
    font-size: 12px;
    font-weight: 600;
    padding: 2px 10px;
    border-radius: 10px;
    background: var(--grm-bg-alt);
    color: var(--grm-text-secondary);
}

/* Empty state */
.grm-empty { text-align:center; padding:32px 16px; color:var(--grm-text-muted); font-size:14px; }
</style>
{% endblock %}

{% block page_content %}
<div class="container">
    <!-- Nav strip -->
    <nav class="grm-nav">
        <a href="/grm-public" class="grm-nav-brand">GRM Portal</a>
        <a href="/grm-public/dashboard" class="grm-nav-link active">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>
            Dashboard
        </a>
        <a href="/grm-public/track-complaint" class="grm-nav-link">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
            Track
        </a>
        <a href="/grm-public/submit-grievance" class="grm-nav-link">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 19V5M5 12l7-7 7 7"/></svg>
            Submit
        </a>
        <a href="/grm-public/reports" class="grm-nav-link">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
            Reports
        </a>
    </nav>

    <!-- Page header -->
    <div class="grm-page-header">
        <h1>Public Dashboard</h1>
        <p>Aggregate statistics for active grievance redress projects.</p>
    </div>

    <!-- Filters -->
    <form method="get" action="/grm-public/dashboard">
        <div class="grm-filter-bar">
            <span class="grm-filter-label">Project</span>
            <select name="project" class="grm-filter-select" onchange="this.form.submit()">
                <option value="">All Projects</option>
                {% for project in projects %}
                <option value="{{ project.name }}" {% if project.name == selected_project %}selected{% endif %}>
                    {{ project.title }}
                </option>
                {% endfor %}
            </select>
            <div class="grm-filter-divider"></div>
            <span class="grm-filter-label">Period</span>
            <select name="range" class="grm-filter-select" onchange="this.form.submit()">
                <option value="7d" {% if selected_range == "7d" %}selected{% endif %}>Last 7 Days</option>
                <option value="30d" {% if selected_range == "30d" %}selected{% endif %}>Last 30 Days</option>
                <option value="90d" {% if selected_range == "90d" %}selected{% endif %}>Last 90 Days</option>
                <option value="1y" {% if selected_range == "1y" %}selected{% endif %}>Last Year</option>
            </select>
        </div>
    </form>

    {% if error %}
    <div class="grm-empty">{{ error }}</div>
    {% elif metrics %}

    <!-- Metric cards -->
    <div class="grm-metrics">
        <div class="grm-metric">
            <div class="grm-metric-value">{{ metrics.overview.total_issues }}</div>
            <div class="grm-metric-label">Total Complaints</div>
        </div>
        <div class="grm-metric">
            <div class="grm-metric-value" style="color:#E67E22;">{{ metrics.overview.open_issues }}</div>
            <div class="grm-metric-label">Open</div>
        </div>
        <div class="grm-metric">
            <div class="grm-metric-value" style="color:#27AE60;">{{ metrics.overview.resolved_issues }}</div>
            <div class="grm-metric-label">Resolved</div>
        </div>
        <div class="grm-metric">
            <div class="grm-metric-value" style="color:var(--grm-accent);">{{ metrics.overview.pending_issues }}</div>
            <div class="grm-metric-label">Pending</div>
        </div>
    </div>

    <!-- Breakdown tables -->
    <div class="row">
        <div class="col-md-6">
            <div class="grm-section-title">By Status</div>
            {% if metrics.status_breakdown %}
            <table class="grm-table">
                <thead><tr><th>Status</th><th>Count</th></tr></thead>
                <tbody>
                    {% for item in metrics.status_breakdown %}
                    <tr><td>{{ item.status }}</td><td><span class="grm-badge">{{ item.count }}</span></td></tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <div class="grm-empty">No data available</div>
            {% endif %}
        </div>
        <div class="col-md-6">
            <div class="grm-section-title">By Category</div>
            {% if metrics.category_breakdown %}
            <table class="grm-table">
                <thead><tr><th>Category</th><th>Count</th></tr></thead>
                <tbody>
                    {% for item in metrics.category_breakdown %}
                    <tr><td>{{ item.category }}</td><td><span class="grm-badge">{{ item.count }}</span></td></tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <div class="grm-empty">No data available</div>
            {% endif %}
        </div>
    </div>

    <div class="grm-section-title">By Region</div>
    {% if metrics.region_breakdown %}
    <table class="grm-table">
        <thead><tr><th>Region</th><th>Count</th></tr></thead>
        <tbody>
            {% for item in metrics.region_breakdown %}
            <tr><td>{{ item.region }}</td><td><span class="grm-badge">{{ item.count }}</span></td></tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="grm-empty">No data available</div>
    {% endif %}

    {% else %}
    <div class="grm-empty">No metrics available.</div>
    {% endif %}
</div>
{% endblock %}
